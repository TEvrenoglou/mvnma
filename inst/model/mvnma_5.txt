

model{
  
  # this controls for studies with one outcome not reported by setting the correlation equal to 
  # zero
  
  for (k in 1:(2*Ns-N2h)){
  
  control12[k] <- step(9999-var1[k])*step(9999-var2[k])
  
  control13[k] <- step(9999-var1[k])*step(9999-var3[k])
  
  control14[k] <- step(9999-var1[k])*step(9999-var4[k])
  
  control15[k] <- step(9999-var1[k])*step(9999-var5[k])
  
  control23[k] <- step(9999-var2[k])*step(9999-var3[k])
  
  control24[k] <- step(9999-var2[k])*step(9999-var4[k])
  
  control25[k] <- step(9999-var2[k])*step(9999-var5[k])
  
  control34[k] <- step(9999-var3[k])*step(9999-var4[k])
  
  control35[k] <- step(9999-var3[k])*step(9999-var5[k])

  control45[k] <- step(9999-var4[k])*step(9999-var5[k])
  
  }
  
  # two-arm studies
  
  for(i in 1:N2h){
    
  ## diagonal  
  
  s[i,1,1] <- var1[i]+psi1.sq
  
  s[i,2,2] <- var2[i]+psi2.sq
  
  s[i,3,3] <- var3[i]+psi3.sq
  
  s[i,4,4] <- var4[i]+psi4.sq
  
  s[i,5,5] <- var5[i]+psi5.sq
  
   ## off diagonal
  
  s[i,1,2] <- control12[i]*rho1*sqrt(var1[i]+psi1.sq)*sqrt(var2[i]+psi2.sq)
  
  s[i,2,1] <- s[i,1,2]
  
  s[i,1,3] <- control13[i]*rho2*sqrt(var1[i]+psi1.sq)*sqrt(var3[i]+psi3.sq)
    
  s[i,3,1] <- s[i,1,3]
  
  s[i,1,4] <- control14[i]*rho3*sqrt(var1[i]+psi1.sq)*sqrt(var4[i]+psi4.sq)
    
  s[i,4,1] <- s[i,1,4]
  
  s[i,1,5] <- control15[i]*rho4*sqrt(var1[i]+psi1.sq)*sqrt(var5[i]+psi5.sq)
    
  s[i,5,1] <- s[i,1,5]
  
  
  s[i,2,3] <- control23[i]*rho5*sqrt(var2[i]+psi2.sq)*sqrt(var3[i]+psi3.sq)
  
  s[i,3,2] <- s[i,2,3]
  
  s[i,2,4] <- control24[i]*rho6*sqrt(var2[i]+psi2.sq)*sqrt(var4[i]+psi4.sq)
  
  s[i,4,2] <- s[i,2,4]
  
  s[i,2,5] <- control25[i]*rho7*sqrt(var2[i]+psi2.sq)*sqrt(var5[i]+psi5.sq)
  
  s[i,5,2] <- s[i,2,5]
  
  
  s[i,3,4] <- control34[i]*rho8*sqrt(var3[i]+psi3.sq)*sqrt(var4[i]+psi4.sq)
  
  s[i,4,3] <- s[i,3,4]
  
  s[i,3,5] <- control35[i]*rho9*sqrt(var3[i]+psi3.sq)*sqrt(var5[i]+psi5.sq)
  
  s[i,5,3] <- s[i,3,5]
  
  
  s[i,4,5] <- control45[i]*rho10*sqrt(var4[i]+psi4.sq)*sqrt(var5[i]+psi5.sq)
  
  s[i,5,4] <- s[i,4,5]
  
  
  y[(5*i-4):(5*i)] ~ dmnorm.vcov(mean[(5*i-4):(5*i)],s[i,,])
    
    }
  
  # three-arm studies
  
  for (i in 1:(Ns-N2h)){
  
  ### diagonal elements
    
    S[i,1,1] <- var1[N2h+2*i-1]+psi1.sq

    S[i,2,2] <- var2[N2h+2*i-1]+psi2.sq

    S[i,3,3] <- var3[N2h+2*i-1]+psi3.sq
    
    S[i,4,4] <- var4[N2h+2*i-1]+psi4.sq
    
    S[i,5,5] <- var5[N2h+2*i-1]+psi5.sq
    
    
    S[i,6,6] <- var1[N2h+2*i]+psi1.sq
    
    S[i,7,7] <- var2[N2h+2*i]+psi2.sq
    
    S[i,8,8] <- var3[N2h+2*i]+psi3.sq
    
    S[i,9,9] <- var4[N2h+2*i]+psi4.sq
    
    S[i,10,10] <- var5[N2h+2*i]+psi5.sq
    
### off-diagonal elements

    S[i,1,2] <- control12[i]*rho1*sqrt(S[i,1,1])*sqrt(S[i,2,2])

    S[i,2,1] <- S[i,1,2]

    S[i,1,3] <- control13[i]*rho2*sqrt(S[i,1,1])*sqrt(S[i,3,3])

    S[i,3,1] <- S[i,1,3]
    
    S[i,1,4] <- control14[i]*rho3*sqrt(S[i,1,1])*sqrt(S[i,4,4])

    S[i,4,1] <- S[i,1,4]
    
    S[i,1,5] <- control15[i]*rho4*sqrt(S[i,1,1])*sqrt(S[i,5,5])
   
    S[i,5,1] <- S[i,1,5]
    
    S[i,1,6] <- sqrt(S[i,1,1])*sqrt(S[i,6,6])/2
    
    S[i,6,1] <- S[i,1,6]
    
    S[i,1,7] <- control12[i]*rho1*sqrt(S[i,1,1])*sqrt(S[i,7,7])/2
    
    S[i,7,1] <- S[i,1,7]
    
    S[i,1,8]<- control13[i]*rho2*sqrt(S[i,1,1])*sqrt(S[i,8,8])/2
    
    S[i,8,1] <- S[i,1,8]
    
    S[i,1,9] <- control14[i]*rho3*sqrt(S[i,1,1])*sqrt(S[i,9,9])/2
    
    S[i,9,1] <- S[i,1,9]
    
    S[i,1,10] <- control15[i]*rho4*sqrt(S[i,1,1])*sqrt(S[i,10,10])/2
    
    S[i,10,1] <- S[i,1,10]
    

    
    S[i,2,3] <- control23[i]*rho5*sqrt(S[i,2,2])*sqrt(S[i,3,3])

    S[i,3,2] <- S[i,2,3]
    
    S[i,2,4] <- control24[i]*rho6*sqrt(S[i,2,2])*sqrt(S[i,4,4])

    S[i,4,2] <- S[i,2,4]
    
    S[i,2,5] <- control25[i]*rho7*sqrt(S[i,2,2])*sqrt(S[i,5,5])

    S[i,5,2] <- S[i,2,5]
    
    S[i,2,6] <- control12[i]*rho1*sqrt(S[i,2,2])*sqrt(S[i,6,6])/2

    S[i,6,2] <- S[i,2,6]
    
    S[i,2,7] <- sqrt(S[i,2,2])*sqrt(S[i,7,7])/2

    S[i,7,2] <- S[i,2,7]
    
    S[i,2,8] <- control23[i]*rho5*sqrt(S[i,2,2])*sqrt(S[i,8,8])/2

    S[i,8,2] <- S[i,2,8]
    
    S[i,2,9] <- control24[i]*rho6*sqrt(S[i,2,2])*sqrt(S[i,9,9])/2

    S[i,9,2] <- S[i,2,9]
    
    S[i,2,10] <- control25[i]*rho7*sqrt(S[i,2,2])*sqrt(S[i,10,10])/2

    S[i,10,2] <- S[i,2,10]
   
   
    S[i,3,4] <- control34[i]*rho8*sqrt(S[i,3,3])*sqrt(S[i,4,4])
    
    S[i,4,3] <- S[i,3,4]
    
    S[i,3,5] <- control35[i]*rho9*sqrt(S[i,3,3])*sqrt(S[i,5,5])
    
    S[i,5,3] <- S[i,3,5]
    
    S[i,3,6] <- control13[i]*rho2*sqrt(S[i,3,3])*sqrt(S[i,6,6])/2
    
    S[i,6,3] <- S[i,3,6]
    
    S[i,3,7] <- control23[i]*rho5*sqrt(S[i,3,3])*sqrt(S[i,7,7])/2
    
    S[i,7,3] <- S[i,3,7]
    
    S[i,3,8] <- sqrt(S[i,3,3])*sqrt(S[i,8,8])/2
    
    S[i,8,3] <- S[i,3,8]
    
    S[i,3,9] <- control34[i]*rho8*sqrt(S[i,3,3])*sqrt(S[i,9,9])/2
    
    S[i,9,3] <- S[i,3,9]
    
    S[i,3,10] <- control35[i]*rho9*sqrt(S[i,3,3])*sqrt(S[i,10,10])/2
    
    S[i,10,3] <- S[i,3,10]
    
   
    
    S[i,4,5] <- control45[i]*rho10*sqrt(S[i,4,4])*sqrt(S[i,5,5])
    
    S[i,5,4] <- S[i,4,5]
    
    S[i,4,6] <- control14[i]*rho3*sqrt(S[i,4,4])*sqrt(S[i,6,6])/2
    
    S[i,6,4] <- S[i,4,6]
    
    S[i,4,7] <- control24[i]*rho6*sqrt(S[i,4,4])*sqrt(S[i,7,7])/2
    
    S[i,7,4] <- S[i,4,7]
    
    S[i,4,8] <- control34[i]*rho8*sqrt(S[i,4,4])*sqrt(S[i,8,8])/2
    
    S[i,8,4] <- S[i,4,8]
    
    S[i,4,9] <- sqrt(S[i,4,4])*sqrt(S[i,9,9])/2
    
    S[i,9,4] <- S[i,4,9]

    S[i,4,10] <- control45[i]*rho10*sqrt(S[i,4,4])*sqrt(S[i,10,10])/2
    
    S[i,10,4] <- S[i,4,10]
    

    S[i,5,6] <- control15[i]*rho4*sqrt(S[i,5,5])*sqrt(S[i,6,6])/2
    
    S[i,6,5] <- S[i,5,6]
    
    S[i,5,7] <- control25[i]*rho7*sqrt(S[i,5,5])*sqrt(S[i,7,7])/2
    
    S[i,7,5] <- S[i,5,7]
    
    S[i,5,8] <- control35[i]*rho9*sqrt(S[i,5,5])*sqrt(S[i,8,8])/2
    
    S[i,8,5] <- S[i,5,8]
    
    S[i,5,9] <- control45[i]*rho10*sqrt(S[i,5,5])*sqrt(S[i,9,9])/2
    
    S[i,9,5] <- S[i,5,9]
    
    S[i,5,10] <- sqrt(S[i,5,5])*sqrt(S[i,10,10])/2
    
    S[i,10,5] <- S[i,5,10]
    
    
    S[i,6,7] <- control12[i]*rho1*sqrt(S[i,6,6])*sqrt(S[i,7,7])
    
    S[i,7,6] <- S[i,6,7]
    
    S[i,6,8] <- control13[i]*rho2*sqrt(S[i,6,6])*sqrt(S[i,8,8])
    
    S[i,8,6] <- S[i,6,8]
    
    S[i,6,9] <- control14[i]*rho3*sqrt(S[i,6,6])*sqrt(S[i,9,9])
    
    S[i,9,6] <- S[i,6,9]
    
    S[i,6,10] <- control15[i]*rho4*sqrt(S[i,6,6])*sqrt(S[i,10,10])
    
    S[i,10,6] <- S[i,6,10]
    
     
    S[i,7,8] <- control23[i]*rho5*sqrt(S[i,7,7])*sqrt(S[i,8,8])
    
    S[i,8,7] <- S[i,7,8]
    
    S[i,7,9] <- control24[i]*rho6*sqrt(S[i,7,7])*sqrt(S[i,9,9])
    
    S[i,9,7] <- S[i,7,9]
    
    S[i,7,10] <- control25[i]*rho7*sqrt(S[i,7,7])*sqrt(S[i,10,10])
    
    S[i,10,7] <- S[i,7,10]
    
    
    S[i,8,9] <- control34[i]*rho8*sqrt(S[i,8,8])*sqrt(S[i,9,9])
    
    S[i,9,8] <- S[i,8,9]
    
    S[i,8,10] <- control35[i]*rho9*sqrt(S[i,8,8])*sqrt(S[i,10,10])
    
    S[i,10,8] <- S[i,8,10]
    
    
    S[i,9,10] <- control45[i]*rho10*sqrt(S[i,9,9])*sqrt(S[i,10,10])
    
    S[i,10,9] <- S[i,9,10]

    

  }

  for (k in 1:(Ns-N2h)){
    
    y[(5*N2h+10*k-9):(5*N2h+10*k)] ~ dmnorm.vcov(mean[(5*N2h+10*k-9):(5*N2h+10*k)],S[k,,])

    }
  # 
  # Parameterization of the means

  for(i in 1:N2h) {

    mean[5*i-4] <- d1[T2[i]] - d1[T1[i]]

    mean[5*i-3] <- d2[T2[i]] - d2[T1[i]]

    mean[5*i-2] <- d3[T2[i]] -  d3[T1[i]]

    mean[5*i-1] <- d4[T2[i]] -  d4[T1[i]]
    
    mean[5*i] <- d5[T2[i]] -  d5[T1[i]]

    }

  for(i in 1:(Ns-N2h)) {

    mean[5*N2h+10*i-9] <- d1[T2[N2h+i]] - d1[T1[N2h+i]]

    mean[5*N2h+10*i-8] <- d2[T2[N2h+i]] - d2[T1[N2h+i]]

    mean[5*N2h+10*i-7] <- d3[T2[N2h+i]] - d3[T1[N2h+i]]

    mean[5*N2h+10*i-6] <- d4[T2[N2h+i]] - d4[T1[N2h+i]]
    
    mean[5*N2h+10*i-5] <- d5[T2[N2h+i]] - d5[T1[N2h+i]]


    mean[5*N2h+10*i-4] <- d1[T3[N2h+i]] - d1[T1[N2h+i]]

    mean[5*N2h+10*i-3] <- d2[T3[N2h+i]] - d2[T1[N2h+i]]

    mean[5*N2h+10*i-2] <- d3[T3[N2h+i]] - d3[T1[N2h+i]]
    
    mean[5*N2h+10*i-1] <- d4[T3[N2h+i]] - d4[T1[N2h+i]]
    
    mean[5*N2h+10*i] <-   d5[T3[N2h+i]] - d5[T1[N2h+i]]
  
   }

  # Priors

  for(k in 1:(ref-1)) {

  d1[k] ~ dnorm(0,1e-03)

  d2[k] ~ dnorm(0,1e-03)

  d3[k] ~ dnorm(0,1e-03)
  
  d4[k] ~ dnorm(0,1e-03)
  
  d5[k] ~ dnorm(0,1e-03)

  }

  for(k in (ref+1):NT) {

  d1[k] ~ dnorm(0,1e-03)

  d2[k] ~ dnorm(0,1e-03)

  d3[k] ~ dnorm(0,1e-03)
  
  d4[k] ~ dnorm(0,1e-03)
  
  d5[k] ~ dnorm(0,1e-03)
  

  }

  psi1.sq <- psi1*psi1
  psi2.sq <- psi2*psi2
  psi3.sq <- psi3*psi3
  psi4.sq <- psi4*psi4
  psi5.sq <- psi5*psi5
  
  psi1 ~ dnorm(0,1)T(0,)
  psi2 ~ dnorm(0,1)T(0,)
  psi3 ~ dnorm(0,1)T(0,)
  psi4 ~ dnorm(0,1)T(0,)
  psi5 ~ dnorm(0,1)T(0,)

  rho1 ~ dunif(lower.rho1, upper.rho1)
  rho2 ~ dunif(lower.rho2, upper.rho2)
  rho3 ~ dunif(lower.rho3, upper.rho3)
  rho4 ~ dunif(lower.rho4, upper.rho4)
  rho5 ~ dunif(lower.rho5, upper.rho5)
  rho6 ~ dunif(lower.rho6, upper.rho6)
  rho7 ~ dunif(lower.rho7, upper.rho7)
  rho8 ~ dunif(lower.rho8, upper.rho8)
  rho9 ~ dunif(lower.rho9, upper.rho9)
  rho10 ~ dunif(lower.rho10, upper.rho10)
  
  #Estimated  Effect Sizes

  d1[ref] <- 0

  d2[ref] <- 0

  d3[ref] <- 0
  
  d4[ref] <- 0
  
  d5[ref] <- 0

  for (c in 1:(ref-1)) {

  res.ref1[c] <- d1[c] - d1[ref]

  res.ref2[c] <- d2[c] - d2[ref]

  res.ref3[c] <- d3[c] - d3[ref]
  
  res.ref4[c] <- d4[c] - d4[ref]
  
  res.ref5[c] <- d5[c] - d5[ref]
  
  

  }

  for (c in (ref+1):NT) {

  res.ref1[c] <- d1[c] - d1[ref]

  res.ref2[c] <- d2[c] - d2[ref]

  res.ref3[c] <- d3[c] - d3[ref]
  
  res.ref4[c] <- d4[c] - d4[ref]
  
  res.ref5[c] <- d5[c] - d5[ref]

  }

  for (c in 1:(NT-1)) {

    for (k in (c+1):NT) {

     res.1[c,k] <- d1[k] - d1[c]

     res.2[c,k] <- d2[k] - d2[c]

     res.3[c,k] <- d3[k] - d3[c]
     
     res.4[c,k] <- d4[k] - d4[c]
     
     res.5[c,k] <- d5[k] - d5[c]
     
     
    }
      }
    
    }
